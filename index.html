<!DOCTYPE html>
<html lang="en">

<head>
	<link rel="stylesheet" href="//code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css"/>
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.css" />

	
	<script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.9.1/jquery-ui.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script>
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.2/underscore-min.js"></script>
	<script type="text/javascript" src="//raw.github.com/flatiron/director/master/build/director.min.js"></script>
	<script type="text/javascript" src="//raw.github.com/raganwald/method-combinators/master/lib/method-combinators.js"></script>
	

	<script type="text/javascript" src="audioplayer/audioplayer.js"></script>
	<script type="text/javascript" src="archiveloader/archiveloader.js"></script>

	<script type="text/template" id="tplPlaylistRecord">
		<li class="playlistEntry">
			<span class="playlistEntryInfo"><%= data.creator %> - <%= data.title %></span>
			<audio preload="none">
				<%= data.streams %>
			</audio>
		</li>
	</script>

	<script type="text/template" id="tplStreamSource">
		<source src="<%= data.url %>">
	</script>

	<script type="text/javascript">
	_.templateSettings.variable = "data";

	_.mixin({
		propertySelect : 	(function (key) {
								return function (obj) { return obj[key]; }
							}),
	});

	(function ($){
		$(document).ready(function (){
			
			audioPlayer.setContainer("playlistContainer");
			//archiveLoader.initSearchBox("searchInput");
			archiveLoader.getCollections()
				.then(function (data, status) {
					var collections = _(data.response.docs).map(function (c) {  return {label: c.title, value:c.identifier}  });
					$("#searchBox").autocomplete({source:collections});	
				});

			var showPlaylist = function (playlist) {
				$.mobile.changePage("#playlistPage");
				audioPlayer.loadPlaylist(playlist.files);
			}

			var pickRandomShow = function (collection, attempt) {
				archiveLoader.randomShowByCollection(collection).
					then(function (playlist) {
						if (playlist.files.length > 0) {
							showPlaylist(playlist.files);
						}
						else if (attempt < 10){
							pickRandomShow(collection);
						}
						else
						{
							alert("Could Not Find a Show");
						}
					});
			}

			$("#searchBox").keypress(function (event) {
				if (event.which == 13) //Enter Key
				{
					archiveLoader.randomShowByCollection($("#searchBox").val()).
						then(showPlaylist);
				}
			});
			
			$("#searchBtn").click(function () { 
				archiveLoader.randomShowByCollection($("#searchBox").val()).
					then(showPlaylist);
			});
		})
	})(jQuery);
	</script>
</head>


<body>
	
	<div data-role="page" id="searchPage">
	    <div data-role="content">
	        <div data-role="fieldcontain">
	            <fieldset data-role="controlgroup">
	                <label for="searchBox">
	                </label>
	                <input name="" id="searchBox" placeholder="Lotus" value="" type="search">
	            </fieldset>
	        </div>
	        <input id="searchBtn" type="submit" data-inline="true" data-theme="a" data-icon="search" data-iconpos="left" value="Search" >
	    </div>
	</div>
	<div data-role="page" id="playlistPage">
	    <div data-role="content">
	        <div>
	            <a id="showTitle" href="" target="_blank" data-transition="fade">
	                Show Name Here
	            </a>
	        </div>
	        <ul id="playlistContainer" data-role="listview" data-divider-theme="c" data-inset="true">
	            <li data-theme="c">
	                <a href="#page1" data-transition="slide">
	                    Song1
	                </a>
	            </li>
	        </ul>
	    </div>
	</div>
	
</body>
</html>